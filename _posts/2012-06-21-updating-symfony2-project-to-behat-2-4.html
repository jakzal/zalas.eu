---
layout: post
title: Updating Symfony2 project to Behat 2.4
tags:
- behat
- mink
- Symfony2
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  description: Recent release of Behat 2.4 brings a lot of extensibility for a price
    of small backward compatibility breaks. Since I just went through an update of
    Behat in a Symfony2 project and there's no guide on the subject yet, I thought
    it's a good idea to share few tips.
  keywords: behat,2.4,Symfony2,symfony,migration
---
<img class="alignleft size-full wp-image-929" title="Behat &amp; Symfony Logo" src="/uploads/wp/2012/06/behat-sf-logo.png" alt="" width="239" height="89" />Recent release of <strong>Behat 2.4</strong> brings a lot of extensibility for a price of small backward compatibility breaks. Since I just went through an update of Behat in a <strong>Symfony2</strong> project and there's no guide on the subject yet, I thought it's a good idea to share few tips.

<strong>Note</strong>: Read more on Behat 2.4 on <a title="everzet on twitter" href="https://twitter.com/#!/everzet">@everzet</a>'s blog: <a title="Behat 2.4: The most extendable testing framework" href="http://everzet.com/post/22899229502/behat-240">Behat 2.4: The most extendable testing framework</a>.

<strong>Update</strong>: This blog post is now part of an official documenation for the Symfony2 Extension: <a title="Migrating from Behat 2.3 to 2.4" href="http://extensions.behat.org/symfony2/migrating_from_2.3_to_2.4.html">Migrating from Behat 2.3 to 2.4</a>.
<h2>There's no BehatBundle nor MinkBundle anymore</h2>
Most important change for the Symfony users is that Behat integration is no longer done with bundles. Behat got its own extension system and there's simply no need for bundles anymore.

So instead of the BehatBundle you'll need to install the <a title="Symfony2Extension" href="https://github.com/Behat/Symfony2Extension">Symfony2Extension</a>. MinkBundle was replaced by the <a title="MinkExtension" href="https://github.com/Behat/MinkExtension">MinkExtension</a> and several drivers (i.e. <a title="MinkSeleniumDriver" href="https://github.com/Behat/MinkSeleniumDriver">MinkSeleniumDriver</a>, <a title="MinkBrowserkitDriver" href="https://github.com/Behat/MinkBrowserkitDriver">MinkBrowserkitDriver</a>).

Here's an example <em>composer.json</em> snippet taken from my Symfony project using both selenium and browserkit drivers:
<pre>{
    "require": {
        "behat/behat":                  "*",
        "behat/symfony2-extension":     "*",
        "behat/mink-extension":         "*",
        "behat/mink-browserkit-driver": "*",
        "behat/mink-selenium-driver":   "*"
    }
}</pre>
<strong>Note</strong>: Naturally initialization of Behat and Mink bundles has to be removed from the <em>AppKernel</em>.
<h2>Accessing the Symfony kernel</h2>
If you've been extending <em>BehatContext</em> from BehatBundle to get access to the Symfony kernel you'll need to alter your code and implement the <em>KernelAwareInterface</em> instead.

The Symfony kernel is injected automatically to every context implementing the <em>KernelAwareInterface</em>:
<pre>namespace Acme\Bundle\AcmeBundle\Features\Context;

use Behat\Behat\Context\BehatContext;
use Behat\Symfony2Extension\Context\KernelAwareInterface;
use Symfony\Component\HttpKernel\KernelInterface;

class AcmeContext extends BehatContext implements KernelAwareInterface
{
    /**
     * @var \Symfony\Component\HttpKernel\KernelInterface $kernel
     */
    private $kernel = null;

    /**
     * @param \Symfony\Component\HttpKernel\KernelInterface $kernel
     *
     * @return null
     */
    public function setKernel(KernelInterface $kernel)
    {
        $this-&gt;kernel = $kernel;
    }
}</pre>
<strong>Note</strong>: Read more on <a title="Symfony2Extension on github" href="https://github.com/Behat/Symfony2Extension">Symfony2Extension on github</a>.
<h2>Accessing Mink session</h2>
It's possible to inject Mink into the context just like it's possible with the Symfony kernel. All you need to do is to implement the <a title="MinkAwareInterface" href="https://github.com/Behat/MinkExtension/blob/master/src/Behat/MinkExtension/Context/MinkAwareInterface.php">MinkAwareInterface</a>.

Alternatively you can extend the <a title="RawMinkContext class" href="https://github.com/Behat/MinkExtension/blob/master/src/Behat/MinkExtension/Context/RawMinkContext.php">RawMinkContext</a>. It has an additional benefit of gaining access to several handy methods (like <em>getSession()</em>, <em>assertSession()</em>, <em>getMinkParameter()</em>).
<pre>namespace Acme\Bundle\AcmeBundle\Features\Context;

use Behat\MinkExtension\Context\RawMinkContext;

class AcmeContext extends RawMinkContext
{
    /**
     * @Given /^I go to (?:|the )homepage$/
     */
    public function iGoToHomepage()
    {
        $this-&gt;getSession()-&gt;visit('/');
    }
}</pre>
<em>RawMinkContext</em> can be safely extended multiple times since it doesn't contain any step definitions (as opposed to <a title="MinkContext" href="https://github.com/Behat/MinkExtension/blob/master/src/Behat/MinkExtension/Context/MinkContext.php">MinkContext</a>).

To take advantage of steps defined in the <em>MinkContext</em> you can simply add it as a subcontext:
<pre>namespace Acme\Bundle\AcmeBundle\Features\Context;

use Acme\Bundle\AcmeBundle\Features\Context\AcmeContext;
use Behat\Behat\Context\BehatContext;
use Behat\MinkExtension\Context\MinkContext;

class FeatureContext extends BehatContext
{
    public function __construct()
    {
        $this-&gt;useContext('acme', new AcmeContext());
        $this-&gt;useContext('mink', new MinkContext());
    }
}</pre>
<strong>Note</strong>: Read more on <a title="MinkExtension" href="https://github.com/Behat/MinkExtension">MinkExtension on github</a>.
<h2>Behat configuration is now separated from Symfony</h2>
Instead of configuring Behat in Symfony you'll need to create a new <em>behat.yml</em> file in the top level directory of your project:
<pre>default:
  formatter:
    name: progress
  extensions:
    Behat\Symfony2Extension\Extension:
      mink_driver: true
      kernel:
        env: test
        debug: true
    Behat\MinkExtension\Extension:
      base_url: 'http://www.acme.dev/app_test.php/'
      default_session: symfony2
      javascript_session: selenium
      selenium:
        host: 33.33.33.1
        port: 4444</pre>
You'll have to remove your previous configuration (typically placed in <em>app/config/config_test.yml</em>). Otherwise dependency injection container will complain on unrecognised parameters.

<strong>Note</strong>: Read more on <em>behat.yml</em> in <a title="behat.yml" href="http://docs.behat.org/guides/7.config.html">the configuration section</a> of the official documentation.
<h2>There's no Symfony command anymore</h2>
As the bundles disappeared and configuration has been separated, we have no Symfony specific command anymore. Behat is now run through its own script.

When using composer it's good to specify the directory you want the commands to be installed in:
<pre>{
    "config": {
        "bin-dir": "bin"
    }
}</pre>
This way Behat will be accessible via:
<pre>./bin/behat</pre>
<h2>Including autoloader from composer</h2>
If you use composer you'll need to make a small change to the <em>app/autoload.php</em> file. The <em>require_once</em> used to include the autoloader needs to be replaced with <em>require</em>:
<pre>$loader = require __DIR__.'/../vendor/autoload.php';</pre>
I didn't dig into the details but I suspect Behat loads the autoloader first. Symfony tries to include it again and <em>require_once</em> returns false instead of the autoloader object.
<h2>Assertions</h2>
To use PHPUnit's assertions you'll need to include them first (I didn't have to do it before):
<pre>require_once 'PHPUnit/Autoload.php';
require_once 'PHPUnit/Framework/Assert/Functions.php';</pre>
It's good for a start but later you'd probably prefer to use new <a title="WebAssert" href="https://github.com/Behat/Mink/blob/master/src/Behat/Mink/WebAssert.php">WebAssert</a> class. Assertions it provides are more suitable for web needs (you should get more meaningful error messages).

<em>RawMinkContext</em> provides a way to create <em>WebAssert</em> object with <em>assertSession()</em>:
<pre>namespace Acme\Bundle\AcmeBundle\Features\Context;

use Behat\MinkExtension\Context\RawMinkContext;

class AcmeContext extends RawMinkContext
{
    /**
     * @Then /^I should see an error message$/
     */
    public function iShouldSeeAnErrorMessage()
    {
        $this-&gt;assertSession()-&gt;elementExists('css', '.error');
    }
}</pre>
<h2>Clearing Doctrine's entity manager</h2>
When creating database entries with Doctrine in your contexts you might need to clear the entity manager before Symfony tries to retrieve any entities:
<pre>$entityManager-&gt;clear();</pre>
I needed to do it practically in every step which creates entities.

If you store objects in contexts (for future use in other steps) you'll have to register them back in the entity manager before using (since you removed them with <em>clear()</em> call):
<pre>$entityManager-&gt;merge($this-&gt;page);</pre>
<h2>Running scenario suite for the whole project</h2>
At the moment there's no way to run a whole project suite. I came up with a simple script solving that problem:
<pre>for feature_path in `find src/ -path '*/Features'`; do
    bundle=$(echo $feature_path | sed -e 's/^[^\/]\+\/\([^\/]\+\)\/Bundle\/\([^\/]\+\)\/.*/\1\2/');
    echo "Running suite for $bundle";
    ./bin/behat "@$bundle";
done</pre>
I also created another variation of it to be run on a CI server (generates reports): <a title="Running all Behat scenarios on CI" href="https://gist.github.com/2951321">https://gist.github.com/2951321</a>
<h2>Is it worth it?</h2>
I like to be up to date with libraries I use. Especially if I have to support the project for a long time.

With Behat 2.4 you'll get a bit more than being up to date with the bug fixes. The way it's been refactored enables you to better design your contexts. It's much easier to make them decoupled from each other.
