---
layout: post
title: How to run Behat scenarios and functional tests from a Symfony bundle in isolation
  of a project?
tags:
- behat
- bundle
- Symfony2
- testing
- travis
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  description: When working on a reusable bundle it's beneficial to run its test suite
    in isolation of a project. This way test suite is not dependent on project's configuration
    or enabled bundles. It is also much easier to run it on a continuos integration
    server like Travis.
  keywords: bundle,behat,functional,test,travis,AppKernel
---
When working on a reusable bundle it's beneficial to run its test suite in isolation of a project. This way test suite is not dependent on project's configuration or enabled bundles. It is also much easier to run it on a continuos integration server like <a title="Travis CI" href="http://travis-ci.org/">Travis</a>.
<h2>AppKernel and configuration</h2>
Providing an <em>AppKernel</em> is the main task we need to do to run both Behat scenarios and functional tests from our bundle without installing it in a Symfony2 project.

Within an <em>AppKernel</em> we're able to register bundles and container configuration (<em>registerBundles()</em> <em>registerContainerConfiguration()</em> methods). Next to the bundle we're working on, we should enable and configure bundles required for it to work.

Configuration is typically done in <em><a title="config_test.yml" href="https://github.com/jakzal/DemoBundle/blob/master/Features/Fixtures/Project/app/config/config_test.yml">config/config_test.yml</a></em> file (scenarios and tests are usually run in a test environment). Most of the time we'll also need a routing file (typically <em><a title="routing_test.yml" href="https://github.com/jakzal/DemoBundle/blob/master/Features/Fixtures/Project/app/config/routing_test.yml">config/routing_test.yml</a></em>).

Last but not least it's good to change the default location of cache and logs to a temporary directory (<em>getCacheDir()</em> and <em>getLogDir()</em> methods).
<pre>&lt;?php

use Symfony\Component\HttpKernel\Kernel;
use Symfony\Component\Config\Loader\LoaderInterface;

class AppKernel extends Kernel
{
    /**
     * @return array
     */
    public function registerBundles()
    {
        return array(
            new Symfony\Bundle\FrameworkBundle\FrameworkBundle(),
            new Symfony\Bundle\TwigBundle\TwigBundle(),
            new Symfony\Bundle\MonologBundle\MonologBundle(),
            new Sensio\Bundle\FrameworkExtraBundle\SensioFrameworkExtraBundle(),
            new Zalas\Bundle\DemoBundle\ZalasDemoBundle()
        );
    }

    /**
     * @return null
     */
    public function registerContainerConfiguration(LoaderInterface $loader)
    {
        $loader-&gt;load(__DIR__.'/config/config_'.$this-&gt;getEnvironment().'.yml');
    }

    /**
     * @return string
     */
    public function getCacheDir()
    {
        return sys_get_temp_dir().'/ZalasDemoBundle/cache';
    }

    /**
     * @return string
     */
    public function getLogDir()
    {
        return sys_get_temp_dir().'/ZalasDemoBundle/logs';
    }
}</pre>
I usually put the kernel in <em>Features/Fixtures/Project/app/AppKernel.php</em> (for Behat) or <em>Tests/Functional/app/AppKernel.php</em> (for functional tests) but the location doesn't matter.

For more flexibility look at the <a title="AppKernel for functional tests in the FrameworkBundle" href="https://github.com/symfony/symfony/tree/master/src/Symfony/Bundle/FrameworkBundle/Tests/Functional/app">FrameworkBundle</a> or <a title="AppKernel for functional tests in the JMSPaymentCoreBundle" href="https://github.com/schmittjoh/JMSPaymentCoreBundle/tree/master/Tests/Functional">JMSPaymentCoreBundle</a>. Both bundles have good examples of parametrized kernel configurations.
<h2>Autoloader</h2>
Using <a title="Composer PHP" href="http://getcomposer.org/">composer</a> solves most of our autoloading problems. We only need to remember of setting <em>target-dir</em> in our <em>composer.json</em> (big thanks to <a title="Adrien Brault on twitter" href="https://twitter.com/AdrienBrault">Adrien Brault</a> for pointing it out):
<pre>{
    "autoload": {
        "psr-0": { "Zalas\\Bundle\\DemoBundle": "" }
    },
    "target-dir": "Zalas/Bundle/DemoBundle"
}</pre>
We'll also need to register an autoloader for annotations (if we use annotations).

Following example of <em>bootstrap.php</em> is a simple implementation of an autoloader for functional tests. To use it with Behat path to the <em>vendor/autoload.php</em> needs to be updated.
<pre>&lt;?php

use Doctrine\Common\Annotations\AnnotationRegistry;

if (!file_exists($file = __DIR__.'/../vendor/autoload.php')) {
    throw new \RuntimeException('Install the dependencies to run the test suite.');
}

$loader = require $file;
AnnotationRegistry::registerLoader(array($loader, 'loadClass'));</pre>
<h2>Behat</h2>
<p style="text-align: left;"><img class="size-full wp-image-943 aligncenter" title="Behat features folder " src="/uploads/wp/2012/07/scenarios.png" alt="Behat features folder" width="359" height="466" />Once we prepared the <em>AppKernel</em> and set up the autoloading we can move to Behat configuration. In particular, we need to define:</p>

<ul>
	<li>paths to features and bootstrap (<em>default.paths.features</em> and <em>default.paths.bootstrap</em>)</li>
	<li>the location of a context class (<em>default.context.class</em>)</li>
	<li>path to the <em>AppKernel</em> (<em>kernel.path</em> for the Symfony2 extension)</li>
	<li>path to the bootstrap file for the Symfony2 extension (<em>kernel.bootsrap</em> for the Symfony2 extension)</li>
</ul>
<pre>default:
  formatter:
    name: progress
  paths:
    <strong>features: Features</strong>
    <strong>bootstrap: %behat.paths.features%/Context</strong>
  context:
    <strong>class: Zalas\Bundle\DemoBundle\Features\Context\FeatureContext</strong>
  extensions:
    Behat\Symfony2Extension\Extension:
      mink_driver: true
      kernel:
        env: test
        debug: true
        <strong>path: Features/Fixtures/Project/app/AppKernel.php</strong>
        <strong>bootstrap: Features/Fixtures/Project/app/bootstrap.php</strong>
    Behat\MinkExtension\Extension:
      base_url: 'http://www.acme.dev/app_test.php/'
      default_session: symfony2</pre>
Now we can run our Behat scenarios without installing the bundle in a Symfony project:
<pre>./vendor/bin/behat</pre>
<h2>Symfony2 functional tests</h2>
<p style="text-align: left;"><img class="size-full wp-image-944 aligncenter" title="Functional tests" src="/uploads/wp/2012/07/tests.png" alt="Functional tests" width="327" height="389" />Configuration for Symfony2 functional tests is done in a standard PHPUnit file (typically <em>phpunit.xml.dist</em>). We need to provide a path to the <em>AppKernel</em> as an environment variable (<em>KERNEL_DIR</em>).</p>

<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;phpunit bootstrap="./Tests/bootstrap.php" color="true"&gt;
  &lt;testsuites&gt;
    &lt;testsuite name="ZalasDemoBundle test suite"&gt;
      &lt;directory suffix="Test.php"&gt;./Tests&lt;/directory&gt;
    &lt;/testsuite&gt;
  &lt;/testsuites&gt;

  &lt;php&gt;
    <strong> &lt;server name="KERNEL_DIR" value="./Tests/Functional/app" /&gt;</strong>
  &lt;/php&gt;

  &lt;filter&gt;
    &lt;whitelist&gt;
      &lt;directory&gt;./&lt;/directory&gt;
      &lt;exclude&gt;
        &lt;directory&gt;./Resources&lt;/directory&gt;
        &lt;directory&gt;./Tests&lt;/directory&gt;
        &lt;directory&gt;./vendor&lt;/directory&gt;
      &lt;/exclude&gt;
    &lt;/whitelist&gt;
  &lt;/filter&gt;
&lt;/phpunit&gt;</pre>
Now we can run our functional tests without installing the bundle in a Symfony project:
<pre>phpunit</pre>
<h2>Travis CI</h2>
With such a setup running our bundle's test suite on an integration server becomes very simple. Here's an example <em>.travis.yml</em> file:
<pre>language: php

php:
  - 5.3
  - 5.4

before_script:
  - curl -s http://getcomposer.org/installer | php
  - php composer.phar --dev install

script:
  - 'phpunit --coverage-text &amp;&amp; ./vendor/bin/behat'</pre>
Need to use a database? Just create it before running the script (don't forget to remove it afterwards):
<pre>before_script:
  - curl -s http://getcomposer.org/installer | php
  - php composer.phar --dev install
  - mysql -e 'CREATE DATABASE zalas_demo_test;'

script:
  - 'phpunit --coverage-text &amp;&amp; ./vendor/bin/behat'

after_script:
  - mysql -e 'DROP DATABASE zalas_demo_test;'</pre>
<h2>Demo</h2>
To demonstrate this approach I prepared a <a title="DemoBundle demonstrates how to run Behat scenarios and functional tests without a Symfony project" href="https://github.com/jakzal/DemoBundle">DemoBundle</a>. You can clone it from github and test how it works yourself, or you can see how it's run on <a title="TDDemoBundle on Travis CI" href="http://travis-ci.org/#!/jakzal/DemoBundle">Travis</a>.
