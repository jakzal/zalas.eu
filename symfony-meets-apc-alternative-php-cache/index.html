<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Symfony meets APC (Alternative PHP Cache) &mdash; Jakub Zalas &mdash; Agile Software Engineer</title>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="verify-v1" content="PBznb5+bhxbUdD7HvioYYudpqitFdLDgjQTv8SwALq4=" />            <meta name="robots" content="index, follow">
        <link rel="shortcut icon" href="//zalas.eu/favicon.ico" />
        <link rel="alternate" type="application/atom+xml" href="//zalas.eu/atom.xml" title="Jakub Zalas activity feed" />
        <link href="//zalas.eu/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="//zalas.eu/css/base.css" rel="stylesheet" type="text/css" />
        <link href="//zalas.eu/css/code.css" rel="stylesheet" type="text/css" />
        <link href="//zalas.eu/components/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
                                    </head>
    <body>
        <div class="container">
            <div class="row">
                        <section itemscope itemtype="http://schema.org/BlogPosting">
        <h1 itemprop="name">Symfony meets APC (Alternative PHP Cache)</h1>
        <div class="post-date pull-right">
            <time itemprop="datePublished" content="2010-07-31" datetime="2010-07-31">31 Jul 2010</time>
        </div>
        <ul class="list-unstyled list-inline post-tag-cloud">
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/apc/">
                    <span class="list-group-item-heading">apc</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/cache/">
                    <span class="list-group-item-heading">cache</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/doctrine/">
                    <span class="list-group-item-heading">doctrine</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/performance/">
                    <span class="list-group-item-heading">performance</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/php/">
                    <span class="list-group-item-heading">php</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/symfony/">
                    <span class="list-group-item-heading">symfony</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="//zalas.eu/tag/xcache/">
                    <span class="list-group-item-heading">xcache</span>
                </a>
            </li>
                    </ul>

                <div class="alert alert-danger">
            <strong>Warning</strong>: This blog post was written a long time ago and might be no longer relevant.
        </div>
        
        <section class="content" itemprop="articleBody"><p>Up to last week I was exclusively an <a href="http://xcache.lighttpd.net/">XCache</a> user if we talk about PHP accelerators. Recently I needed to use <a href="http://php.net/apc">APC</a> with a symfony application. As symfony offers nice APC integration it went quite smooth.</p>

<p>Note that just enabling PHP accelerator (any) improves performance because of the opcode caching. That's why it should always be used on the production environment. Most of accelerators also offer API which enables us to cache anything.</p>

<h2 id="php-accelerators-in-symfony">PHP Accelerators in symfony</h2>

<p>Taking advantage of the most popular accelerators is really easy in symfony. We are able to change caching strategies for several factories (view, internationalization, routing). We can also cache Doctrine's DQL queries and results.</p>

<p>Symfony not only offers <strong>APC</strong> support with <em>sfAPCCache</em> class but there are also drivers for <strong>XCache</strong> (<em>sfXCacheCache</em>), <strong>EAccelerator</strong> (<em>sfEacceleratorCache</em>), <strong>memcache</strong> (<em>sfMemcacheCache</em>) and <strong>SQLite</strong> (<em>sfSQLiteCache</em>). We can also quite easily implement our own driver by extending sfCache class.</p>

<p>This short tutorial could be also used for any other accelerator. It's just a matter of replacing <em>sfAPCCache</em>/<em>Doctrine_Query_Cache</em> with appropriate classes.</p>

<h2 id="enabling-apc-in-factories">Enabling APC in Factories</h2>

<p>All caching strategies are set to <em>sfFileCache</em> by default. We are able to change the settings for routing, view and i18n in a factory file (i.e. <em>apps/frontend/config/factories.yml</em>):</p>

<pre><code class="yaml">all:
  routing:
    class: sfPatternRouting
    param:
      generate_shortest_url:            true
      extra_parameters_as_query_string: true
      cache:
        class: sfAPCCache
        param:
          automatic_cleaning_factor: 0
          lifetime:                  31556926

  view_cache:
    class: sfAPCCache

  i18n:
    param:
      cache:
        class: sfAPCCache
        param:
          automatic_cleaning_factor: 0
          lifetime:                  31556926
</code></pre>

<p>From now on our routing, view cache and translations will be stored in a memory instead of a hard drive. This way symfony makes a lot less disk operations (which are slow).</p>

<h2 id="enabling-dql-and-result-cache-in-doctrine">Enabling DQL and Result Cache in Doctrine</h2>

<p>Enabling query cache in Doctrine is a quite safe operation. As long as we use prepared statements and don't create queries by string concatenation we don't have to worry. I think query cache can be enabled in most well written projects.</p>

<p>In symfony Doctrine is configured in <em>configureDoctrine()</em> method of the project configuration class (<em>config/ProjectConfiguration.class.php</em>). Enabling query cache is a matter of setting <em>ATTR_QUERY_CACHE</em> attribute:</p>

<pre><code class="php">/**
 * @param Doctrine_Manager $manager
 * @return null
 */
public function configureDoctrine(Doctrine_Manager $manager)
{
  $manager-&gt;setAttribute(Doctrine_Core::ATTR_QUERY_CACHE, new Doctrine_Cache_Apc());
}
</code></pre>

<p>Enabling result cache might be tricky. It really depends on the project. Various result sets could have different life times. Also, result cannot be cached if we work with quickly changing data ("once it's retrieved it's outdated" kind of thing). Enabling result cache for everything in most situations won't be the best solution:</p>

<pre><code class="php">$manager-&gt;setAttribute(Doctrine_Core::ATTR_RESULT_CACHE, new Doctrine_Cache_Apc());
</code></pre>

<p>It's worth to mention that both query and result caches can be enabled not only on a manager level but also on the connection and query levels:</p>

<pre><code class="php">// Connection level result cache
$connection-&gt;setAttribute(Doctrine_Core::ATTR_RESULT_CACHE, new Doctrine_Cache_Apc());

// Query level query cache
$query = Doctrine_Query::create()
  -&gt;useQueryCache(new Doctrine_Cache_Apc());

// Query level result cache
$query = Doctrine_Query::create()
  -&gt;useResultCache(new Doctrine_Cache_Apc());
</code></pre>

<p>Doctrine's documentation offers detailed description of both query and result caches: <a href="http://www.doctrine-project.org/documentation/manual/1_2/en/caching:query-cache-&amp;-result-cache">Query Cache &amp; Result Cache</a>.</p>

<h2 id="the-future-of-apc">The Future of APC</h2>

<p>Long time ago I chose XCache because at that time it was better maintained and there was no performance difference. Now that APC is actively developed and there are plans to include it in PHP core I have to reconsider my decision.</p>

<p>What do you use? Why? Did you run any benchmarks?</p>
</section>
    </section>


        <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'zalas';
        var disqus_identifier = 'symfony-meets-apc-alternative-php-cache';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
            </div>
        </div>
                                <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-607315-8', 'auto');
                ga('send', 'pageview');
            </script>
            
            
            <script src="//zalas.eu/components/highlightjs/highlight.pack.js"></script>
            <script>hljs.initHighlightingOnLoad();</script>
                    </body>
</html>
