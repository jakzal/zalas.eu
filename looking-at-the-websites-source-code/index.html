<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Looking at the website&#039;s source code &mdash; Jakub Zalas &mdash; Agile Software Engineer</title>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="verify-v1" content="PBznb5+bhxbUdD7HvioYYudpqitFdLDgjQTv8SwALq4=" />            <meta name="robots" content="index, follow">
        <link rel="shortcut icon" href="http://zalas.eu/favicon.ico" />
        <link rel="alternate" type="application/atom+xml" href="http://zalas.eu/atom.xml" title="Jakub Zalas activity feed" />
        <link href="http://zalas.eu/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="http://zalas.eu/css/base.css" rel="stylesheet" type="text/css" />
        <link href="http://zalas.eu/css/code.css" rel="stylesheet" type="text/css" />
        <link href="http://zalas.eu/components/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
                                    </head>
    <body>
        <div class="container">
            <div class="row">
                        <section itemscope itemtype="http://schema.org/BlogPosting">
        <h1 itemprop="name">Looking at the website&#039;s source code</h1>
        <div class="post-date pull-right">
            <time itemprop="datePublished" content="2009-04-15" datetime="2009-04-15">15 Apr 2009</time>
        </div>
        <ul class="list-unstyled list-inline post-tag-cloud">
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="http://zalas.eu/tag/cache/">
                    <span class="list-group-item-heading">cache</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="http://zalas.eu/tag/filter/">
                    <span class="list-group-item-heading">filter</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="http://zalas.eu/tag/html/">
                    <span class="list-group-item-heading">html</span>
                </a>
            </li>
                        <li>
                <span class="glyphicon glyphicon-tag"></span>
                <a href="http://zalas.eu/tag/symfony/">
                    <span class="list-group-item-heading">symfony</span>
                </a>
            </li>
                    </ul>

                <div class="alert alert-danger">
            <strong>Warning</strong>: This blog post was written a long time ago and might be no longer relevant.
        </div>
        
        <section class="content" itemprop="articleBody"><p>Most of the web programmers have some kind of deviation that tells them to look
into the source code of the websites they visit. In many cases author planned to
have nice indented output. In other cases author just didn't care.</p>

<p>Usually templates are designed to produce output like:</p>

<pre><code class="html">&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My great website&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div&gt;
      &lt;h1&gt;Hello!&lt;/h1&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>but most often what's generated looks more like:</p>

<pre><code class="html">&lt;html&gt;  &lt;head&gt;
            &lt;title&gt;My great website&lt;/title&gt;  &lt;/head&gt;
    &lt;body&gt;
 &lt;div&gt;
      &lt;h1&gt;Hello!&lt;/h1&gt;    &lt;/div&gt;  &lt;/body&gt;
             &lt;/html&gt;
</code></pre>

<p>Tools like Opera's <a href="http://www.opera.com/dragonfly/">Dragonfly</a> or
<a href="http://getfirebug.com/">Firebug</a> for Firefox can help us to view the source in
nice way. Html indentation matters only in the templates so designers and
programmers can read it easily while developments. For browser or crawler it
doesn't matter. Everything could be placed in one long line of code. Whitespace
characters are just empty data which needs to go between the server and user's
browser. The bigger is the website the more whitespace characters needs to be
transfered and it's not even displayed. Maybe it's not such a big deal one could
say. But it's also not such a big job to remove it...</p>

<pre><code class="html">&lt;html&gt;&lt;head&gt;&lt;title&gt;My great website&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;div&gt;&lt;h1&gt;Hello!&lt;/h1&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre>

<p>Symfony processes request in a
<a href="http://www.symfony-project.org/book/1_2/06-Inside-the-Controller-Layer#chapter_06_filters">filter chain</a>.
I will show how to write a filter which removes all the whitespace characters
(omitting pre-formated text of course).
I called the class <em>zContentCleanerFilter</em>.</p>

<p>Let's start with main filter method - <em>execute()</em>. In this method first we'll
execute next filter in the chain to let all the content be generated. If it's
the first call of the filter and cleaning is turned on
(<em>app_content_cleaner_enabled</em> configuration option is set to true) we invoke
the cleaning method on the content (<em>zContentCleanerFilter::cleanContent()</em>)
and overwrite it in the response object.</p>

<pre><code class="php">class zContentCleanerFilter extends sfFilter
{
  public function execute($filterChain)
  {
    $filterChain-&gt;execute();

    if ($this-&gt;isFirstCall() &amp;&amp; sfConfig::get('app_content_cleaner_enabled', false))
    {
      $response = $this-&gt;getContext()-&gt;getResponse();
      $content  = $response-&gt;getContent();
      $content  = self::cleanContent($content);

      $response-&gt;setContent($content);
    }
  }
}
</code></pre>

<p><em>zContentCleanerFilter::cleanContent()</em> method uses callback function to
process content line by line.</p>

<pre><code class="php">  public static function cleanContent($content)
  {
    return preg_replace_callback(
      '/^((\s*)(.*?)(\s*)(\r\n|\r|\n)|(\s*))/smi',
      array('zContentCleanerFilter', 'cleanLine'),
      $content
    );
  }
</code></pre>

<p>We have to check each line for preformatted text. If part of html code is
inside <code>&lt;pre&gt;</code> tag than <em>zContentCleanerFilter::cleanLine()</em> returns
it as is.</p>

<pre><code class="php">  private static function cleanLine($matches)
  {
    static $preCount = 0;

    $line = $matches[0];

    $startPreCount = substr_count($line, '&lt;pre');
    $endPreCount   = substr_count($line, '&lt;/pre&gt;');

    $preCount+= $startPreCount;
    $preCount-= $endPreCount;

    if ($preCount !== 0)
    {
      if (false !== strpos($line, '&lt;pre') &amp;&amp; $startPreCount !== $endPreCount)
      {
        // Preformatted code is starting, remove only white-spaces from the beginning
        $line = ltrim($line);
      }
    }
    elseif (false !== strpos($line, '&lt;/pre') &amp;&amp; $startPreCount !== $endPreCount)
    {
      // Preformatted code is ending, remove only trailing white-spaces
      $line = rtrim($line);
    }
    else
    {
      $line = trim($line);
    }

    return $line;
  }
</code></pre>

<p>That's all. To use the filter in a project we have to configure it to be run in
the filter chain. I've added it into application's <em>factories.yml</em> file
after the cache filter.</p>

<pre><code class="yaml">rendering: ~
security:  ~
cache:     ~

# it's here to cache result when page is cached with layout
contentCleaner:
  class: zContentCleanerFilter

common: ~
execution: ~
</code></pre>

<p>Running content cleaning filter after cache filter takes advantage of caching
the result of cleaning (which could be taken as not efficient). Cache filter is
invoked sooner and skips filters which should be run afterwards.</p>
</section>
    </section>


        <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'zalas';
        var disqus_identifier = 'looking-at-the-websites-source-code';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
            </div>
        </div>
                                <script>
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-607315-8', 'auto');
                ga('send', 'pageview');
            </script>
            
            
            <script src="http://zalas.eu/components/highlightjs/highlight.pack.js"></script>
            <script>hljs.initHighlightingOnLoad();</script>
                    </body>
</html>
